<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Tracing a CloudFormation resource from template to autogenerated value](#tracing-a-cloudformation-resource-from-template-to-autogenerated-value)
  - [CloudFormation template](#cloudformation-template)
  - [servicemap](#servicemap)
  - [boatswain](#boatswain)
  - [values.yaml](#valuesyaml)
- [Bro, do you even CloudFormate?](#bro-do-you-even-cloudformate)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

boatswain has the ability to provision staging environments with AWS resources generated from CloudFormation templates. It can provision an EBS Volume to store MySQL data, ElastiCache, RDS, SQS â€” anything the app needs to function. CloudFormation templates are defined in the deployment/.cloudformation directory, invoked in servicemap definitions, and once provisioned will output an identifier to be dropped into the autogenerated values file and consumed by the staging app.

## Tracing a CloudFormation resource from template to autogenerated value

### CloudFormation template

Let's use the cloudformation template `ebs-hydra-mysql.yaml`. Here it is:

```yaml
# deployment/.cloudformation/ebs-hydra-mysql.yaml

AWSTemplateFormatVersion: 2010-09-09
Description: >-
  App: Hydra DB
  Create EBS Volume from a snapshot for the Hydra MySQL database. 
Metadata:
  Name: ebs-hydra-mydql
Resources:
  EBSVolume:
    Type: "AWS::EC2::Volume"
    Properties:
      AvailabilityZone: us-west-2a
      Encrypted: false
      Size: 100
      Tags:
        - Key: datasource
          Value: hydra
      VolumeType: standard
      SnapshotId: snap-12345
Outputs:
  AwsEbsVolumeId:
    Description: AwsEbsVolumeId
    Value: !Ref EBSVolume
 ```
 
 ### servicemap
 
 In order to make use of this template, we need to invoke this template _by file name_ in a servicemap definition. Like this:
 ```yaml
 # deployment/.servicemaps/staging.yaml
 
 ServiceMaps:
   - Name: hydra
     CloudFormationTemplate: ebs-hydra-mysql
 ```
  
This is the complete servicemap entry for hydra. It doesn't need to talk to any other services, and its database lives in the same deployment, so there's no `Test` or `Staging` services.

 ### boatswain

When boatswain pushes hydra to staging (`boatswain stage push hydra branch-name`) it will find a `CloudFormationTemplate` value in the servicemap for hydra, look for that template by name in the .cloudformation directory, and create the CloudFormation stack from the template using the AWS SDK. 
 
 ### values.yaml

The AWS SDK will return some kind of output upon creating the CloudFormation stack. This output is customizable based on the needs of the app. To take our ebs-hydra-mysql.yaml sample again:
```yaml
Outputs:
  AwsEbsVolumeId:
    Description: AwsEbsVolumeId
    Value: !Ref EBSVolume
```
This block of yaml tells AWS to return the AwsEbsVolumeId value from the stack and set it to the property name `AwsEbsVolumeId`. boatswain assumes that whatever is outputted from the AWS SDK CreateStack command needs to be dropped into the autogenerated values file. So we end up with this:

```yaml
# deployment/hydra/autogenerated/values.staging.my-branch.yaml
Boatswain:
  CloudFormationValues:
    AwsEbsVolumeId: vol-abc123
```

It's then up to the developer to configure the helm templates to make use of `.Values.Boatswain.CloudFormationValues.AwsEbsVolumeId`.

## Bro, do you even CloudFormate?

The details of how to develop CloudFormation templates are outside the scope of this document. For more information on how to build CloudFormation templates, [visit the CloudFormation template page](https://aws.amazon.com/cloudformation/aws-cloudformation-templates/)
